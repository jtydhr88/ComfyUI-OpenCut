"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[298],{14700:(e,t,a)=>{a.d(t,{Oy:()=>i,aI:()=>l,hX:()=>d,xK:()=>n,zb:()=>o});var r=a(93146);function i(e){return[...e].sort((e,t)=>"text"===e.type&&"text"!==t.type?-1:"text"===t.type&&"text"!==e.type||"audio"===e.type&&"audio"!==t.type?1:"audio"===t.type&&"audio"!==e.type?-1:e.isMain&&!t.isMain&&"audio"!==t.type&&"text"!==t.type?1:t.isMain&&!e.isMain&&"audio"!==e.type&&"text"!==e.type?-1:0)}function n(e){return e.find(e=>e.isMain)||null}function o(e){return e.some(e=>e.isMain)?e:[{id:(0,r.lk)(),name:"Main Track",type:"media",elements:[],muted:!1,isMain:!0},...e]}function d(e,t){return"text"===e?"text"===t:"media"===e&&("media"===t||"audio"===t)}function l(e,t){return d(e.type,t.type)?{isValid:!0}:{isValid:!1,errorMessage:"text"===e.type?"Text elements can only be placed on text tracks":"Media elements can only be placed on media or audio tracks"}}},19439:(e,t,a)=>{a.d(t,{P:()=>o});class r{async getDB(){return new Promise((e,t)=>{let a=indexedDB.open(this.dbName,this.version);a.onerror=()=>t(a.error),a.onsuccess=()=>e(a.result),a.onupgradeneeded=e=>{let t=e.target.result;t.objectStoreNames.contains(this.storeName)||t.createObjectStore(this.storeName,{keyPath:"id"})}})}async get(e){let t=(await this.getDB()).transaction([this.storeName],"readonly").objectStore(this.storeName);return new Promise((a,r)=>{let i=t.get(e);i.onerror=()=>r(i.error),i.onsuccess=()=>a(i.result||null)})}async set(e,t){let a=(await this.getDB()).transaction([this.storeName],"readwrite").objectStore(this.storeName);return new Promise((r,i)=>{let n=a.put({id:e,...t});n.onerror=()=>i(n.error),n.onsuccess=()=>r()})}async remove(e){let t=(await this.getDB()).transaction([this.storeName],"readwrite").objectStore(this.storeName);return new Promise((a,r)=>{let i=t.delete(e);i.onerror=()=>r(i.error),i.onsuccess=()=>a()})}async list(){let e=(await this.getDB()).transaction([this.storeName],"readonly").objectStore(this.storeName);return new Promise((t,a)=>{let r=e.getAllKeys();r.onerror=()=>a(r.error),r.onsuccess=()=>t(r.result)})}async clear(){let e=(await this.getDB()).transaction([this.storeName],"readwrite").objectStore(this.storeName);return new Promise((t,a)=>{let r=e.clear();r.onerror=()=>a(r.error),r.onsuccess=()=>t()})}constructor(e,t,a=1){this.dbName=e,this.storeName=t,this.version=a}}class i{async getDirectory(){let e=await navigator.storage.getDirectory();return await e.getDirectoryHandle(this.directoryName,{create:!0})}async get(e){try{let t=await this.getDirectory(),a=await t.getFileHandle(e);return await a.getFile()}catch(e){if("NotFoundError"===e.name)return null;throw e}}async set(e,t){let a=await this.getDirectory(),r=await a.getFileHandle(e,{create:!0}),i=await r.createWritable();await i.write(t),await i.close()}async remove(e){try{let t=await this.getDirectory();await t.removeEntry(e)}catch(e){if("NotFoundError"!==e.name)throw e}}async list(){let e=await this.getDirectory(),t=[];for await(let a of e.keys())t.push(a);return t}async clear(){let e=await this.getDirectory();for await(let t of e.keys())await e.removeEntry(t)}static isSupported(){return"storage"in navigator&&"getDirectory"in navigator.storage}constructor(e="media"){this.directoryName=e}}class n{getProjectMediaAdapters(e){return{mediaMetadataAdapter:new r("".concat(this.config.mediaDb,"-").concat(e),"media-metadata",this.config.version),mediaFilesAdapter:new i("media-files-".concat(e))}}getProjectTimelineAdapter(e){return new r("".concat(this.config.timelineDb,"-").concat(e),"timeline",this.config.version)}async saveProject(e){let t={id:e.id,name:e.name,thumbnail:e.thumbnail,createdAt:e.createdAt.toISOString(),updatedAt:e.updatedAt.toISOString(),backgroundColor:e.backgroundColor,backgroundType:e.backgroundType,blurIntensity:e.blurIntensity,bookmarks:e.bookmarks,fps:e.fps,canvasSize:e.canvasSize,canvasMode:e.canvasMode};await this.projectsAdapter.set(e.id,t)}async loadProject(e){let t=await this.projectsAdapter.get(e);return t?{id:t.id,name:t.name,thumbnail:t.thumbnail,createdAt:new Date(t.createdAt),updatedAt:new Date(t.updatedAt),backgroundColor:t.backgroundColor,backgroundType:t.backgroundType,blurIntensity:t.blurIntensity,bookmarks:t.bookmarks,fps:t.fps,canvasSize:t.canvasSize,canvasMode:t.canvasMode}:null}async loadAllProjects(){let e=await this.projectsAdapter.list(),t=[];for(let a of e){let e=await this.loadProject(a);e&&t.push(e)}return t.sort((e,t)=>t.updatedAt.getTime()-e.updatedAt.getTime())}async deleteProject(e){await this.projectsAdapter.remove(e)}async saveMediaItem(e,t){let{mediaMetadataAdapter:a,mediaFilesAdapter:r}=this.getProjectMediaAdapters(e);await r.set(t.id,t.file);let i={id:t.id,name:t.name,type:t.type,size:t.file.size,lastModified:t.file.lastModified,width:t.width,height:t.height,duration:t.duration};await a.set(t.id,i)}async loadMediaItem(e,t){let{mediaMetadataAdapter:a,mediaFilesAdapter:r}=this.getProjectMediaAdapters(e),[i,n]=await Promise.all([r.get(t),a.get(t)]);if(!i||!n)return null;let o=URL.createObjectURL(i);return{id:n.id,name:n.name,type:n.type,file:i,url:o,width:n.width,height:n.height,duration:n.duration}}async loadAllMediaItems(e){let{mediaMetadataAdapter:t}=this.getProjectMediaAdapters(e),a=await t.list(),r=[];for(let t of a){let a=await this.loadMediaItem(e,t);a&&r.push(a)}return r}async deleteMediaItem(e,t){let{mediaMetadataAdapter:a,mediaFilesAdapter:r}=this.getProjectMediaAdapters(e);await Promise.all([r.remove(t),a.remove(t)])}async deleteProjectMedia(e){let{mediaMetadataAdapter:t,mediaFilesAdapter:a}=this.getProjectMediaAdapters(e);await Promise.all([t.clear(),a.clear()])}async saveTimeline(e,t){let a=this.getProjectTimelineAdapter(e),r={tracks:t,lastModified:new Date().toISOString()};await a.set("timeline",r)}async loadTimeline(e){let t=this.getProjectTimelineAdapter(e),a=await t.get("timeline");return a?a.tracks:null}async deleteProjectTimeline(e){let t=this.getProjectTimelineAdapter(e);await t.remove("timeline")}async clearAllData(){await this.projectsAdapter.clear()}async getStorageInfo(){return{projects:(await this.projectsAdapter.list()).length,isOPFSSupported:this.isOPFSSupported(),isIndexedDBSupported:this.isIndexedDBSupported()}}async getProjectStorageInfo(e){let{mediaMetadataAdapter:t}=this.getProjectMediaAdapters(e),a=this.getProjectTimelineAdapter(e),[r,i]=await Promise.all([t.list(),a.get("timeline")]);return{mediaItems:r.length,hasTimeline:!!i}}async loadSavedSounds(){try{return await this.savedSoundsAdapter.get("user-sounds")||{sounds:[],lastModified:new Date().toISOString()}}catch(e){return{sounds:[],lastModified:new Date().toISOString()}}}async saveSoundEffect(e){try{let t=await this.loadSavedSounds();if(t.sounds.some(t=>t.id===e.id))return;let a={id:e.id,name:e.name,username:e.username,previewUrl:e.previewUrl,downloadUrl:e.downloadUrl,duration:e.duration,tags:e.tags,license:e.license,savedAt:new Date().toISOString()},r={sounds:[...t.sounds,a],lastModified:new Date().toISOString()};await this.savedSoundsAdapter.set("user-sounds",r)}catch(e){throw e}}async removeSavedSound(e){try{let t={sounds:(await this.loadSavedSounds()).sounds.filter(t=>t.id!==e),lastModified:new Date().toISOString()};await this.savedSoundsAdapter.set("user-sounds",t)}catch(e){throw e}}async isSoundSaved(e){try{return(await this.loadSavedSounds()).sounds.some(t=>t.id===e)}catch(e){return!1}}async clearSavedSounds(){try{await this.savedSoundsAdapter.remove("user-sounds")}catch(e){throw e}}isOPFSSupported(){return i.isSupported()}isIndexedDBSupported(){return"indexedDB"in window}isFullySupported(){return this.isIndexedDBSupported()&&this.isOPFSSupported()}constructor(){this.config={projectsDb:"video-editor-projects",mediaDb:"video-editor-media",timelineDb:"video-editor-timelines",savedSoundsDb:"video-editor-saved-sounds",version:1},this.projectsAdapter=new r(this.config.projectsDb,"projects",this.config.version),this.savedSoundsAdapter=new r(this.config.savedSoundsDb,"saved-sounds",this.config.version)}}let o=new n},80196:(e,t,a)=>{a.d(t,{B:()=>u,C:()=>m,generateVideoThumbnail:()=>s,getFileType:()=>d,getImageDimensions:()=>l,getMediaDuration:()=>c});var r=a(59467),i=a(19439),n=a(91685),o=a(93146);let d=e=>{let{type:t}=e;return t.startsWith("image/")?"image":t.startsWith("video/")?"video":t.startsWith("audio/")?"audio":null},l=e=>new Promise((t,a)=>{let r=new window.Image;r.addEventListener("load",()=>{t({width:r.naturalWidth,height:r.naturalHeight}),r.remove()}),r.addEventListener("error",()=>{a(Error("Could not load image")),r.remove()}),r.src=URL.createObjectURL(e)}),s=e=>new Promise((t,a)=>{let r=document.createElement("video"),i=document.createElement("canvas"),n=i.getContext("2d");if(!n)return void a(Error("Could not get canvas context"));r.addEventListener("loadedmetadata",()=>{i.width=r.videoWidth,i.height=r.videoHeight,r.currentTime=Math.min(1,.1*r.duration)}),r.addEventListener("seeked",()=>{n.drawImage(r,0,0,i.width,i.height);let e=i.toDataURL("image/jpeg",.8);t({thumbnailUrl:e,width:r.videoWidth,height:r.videoHeight}),r.remove(),i.remove()}),r.addEventListener("error",()=>{a(Error("Could not load video")),r.remove(),i.remove()}),r.src=URL.createObjectURL(e),r.load()}),c=e=>new Promise((t,a)=>{let r=document.createElement(e.type.startsWith("video/")?"video":"audio");r.addEventListener("loadedmetadata",()=>{t(r.duration),r.remove()}),r.addEventListener("error",()=>{a(Error("Could not load media")),r.remove()}),r.src=URL.createObjectURL(e),r.load()}),m=e=>e.width&&e.height?e.width/e.height:16/9,u=(0,r.v)((e,t)=>({mediaItems:[],isLoading:!1,addMediaItem:async(t,a)=>{let r={...a,id:(0,o.lk)()};e(e=>({mediaItems:[...e.mediaItems,r]}));try{await i.P.saveMediaItem(t,r)}catch(t){e(e=>({mediaItems:e.mediaItems.filter(e=>e.id!==r.id)}))}},removeMediaItem:async(a,r)=>{let o=t().mediaItems.find(e=>e.id===r);(null==o?void 0:o.url)&&(URL.revokeObjectURL(o.url),o.thumbnailUrl&&URL.revokeObjectURL(o.thumbnailUrl)),e(e=>({mediaItems:e.mediaItems.filter(e=>e.id!==r)}));let{tracks:d,removeElementFromTrack:l,removeElementFromTrackWithRipple:s,rippleEditingEnabled:c,pushHistory:m}=n.A.getState(),u=[];for(let e of d)for(let t of e.elements)"media"===t.type&&t.mediaId===r&&u.push({trackId:e.id,elementId:t.id});if(u.length>0)for(let{trackId:e,elementId:t}of(m(),u))c?s(e,t,!1):l(e,t,!1);try{await i.P.deleteMediaItem(a,r)}catch(e){}},loadProjectMedia:async t=>{e({isLoading:!0});try{let a=await i.P.loadAllMediaItems(t),r=await Promise.all(a.map(async e=>{if("video"===e.type&&e.file)try{let{thumbnailUrl:t,width:a,height:r}=await s(e.file);return{...e,thumbnailUrl:t,width:a||e.width,height:r||e.height}}catch(e){}return e}));e({mediaItems:r})}catch(e){}finally{e({isLoading:!1})}},clearProjectMedia:async a=>{let r=t();r.mediaItems.forEach(e=>{e.url&&URL.revokeObjectURL(e.url),e.thumbnailUrl&&URL.revokeObjectURL(e.thumbnailUrl)}),e({mediaItems:[]});try{let e=r.mediaItems.map(e=>e.id);await Promise.all(e.map(e=>i.P.deleteMediaItem(a,e)))}catch(e){}},clearAllMedia:()=>{t().mediaItems.forEach(e=>{e.url&&URL.revokeObjectURL(e.url),e.thumbnailUrl&&URL.revokeObjectURL(e.thumbnailUrl)}),e({mediaItems:[]})}}))},82337:(e,t,a)=>{a.d(t,{I:()=>m,l:()=>s});var r=a(59467),i=a(19439),n=a(61557),o=a(80196),d=a(91685),l=a(93146);let s={width:1920,height:1080},c={id:(0,l.lk)(),name:"Untitled",thumbnail:"",createdAt:new Date,updatedAt:new Date,backgroundColor:"#000000",backgroundType:"color",blurIntensity:8,bookmarks:[],fps:30,canvasSize:s,canvasMode:"preset"},m=(0,r.v)((e,t)=>({activeProject:null,savedProjects:[],isLoading:!0,isInitialized:!1,invalidProjectIds:new Set,toggleBookmark:async a=>{let r,{activeProject:o}=t();if(!o)return;let d=o.fps||30,l=Math.round(a*d)/d,s=o.bookmarks||[],c=s.findIndex(e=>.001>Math.abs(e-l));r=-1!==c?s.filter((e,t)=>t!==c):[...s,l].sort((e,t)=>e-t);let m={...o,bookmarks:r,updatedAt:new Date};try{await i.P.saveProject(m),e({activeProject:m}),await t().loadAllProjects()}catch(e){n.oR.error("Failed to update bookmarks",{description:"Please try again"})}},isBookmarked:e=>{let{activeProject:a}=t();if(!a||!a.bookmarks)return!1;let r=a.fps||30,i=Math.round(e*r)/r;return a.bookmarks.some(e=>.001>Math.abs(e-i))},removeBookmark:async a=>{let{activeProject:r}=t();if(!r||!r.bookmarks)return;let o=r.fps||30,d=Math.round(a*o)/o,l=r.bookmarks.filter(e=>Math.abs(e-d)>=.001);if(l.length===r.bookmarks.length)return;let s={...r,bookmarks:l,updatedAt:new Date};try{await i.P.saveProject(s),e({activeProject:s}),await t().loadAllProjects()}catch(e){n.oR.error("Failed to remove bookmark",{description:"Please try again"})}},createNewProject:async a=>{let r={...c,name:a};e({activeProject:r});try{return await i.P.saveProject(r),await t().loadAllProjects(),r.id}catch(e){throw n.oR.error("Failed to save new project"),e}},loadProject:async a=>{t().isInitialized||e({isLoading:!0});let r=o.B.getState(),n=d.A.getState();r.clearAllMedia(),n.clearTimeline();try{let t=await i.P.loadProject(a);if(t)e({activeProject:t}),await Promise.all([r.loadProjectMedia(a),n.loadProjectTimeline(a)]);else throw Error("Project with id ".concat(a," not found"))}catch(e){throw e}finally{e({isLoading:!1})}},saveCurrentProject:async()=>{let{activeProject:e}=t();if(e)try{let a=d.A.getState();await Promise.all([i.P.saveProject(e),a.saveProjectTimeline(e.id)]),await t().loadAllProjects()}catch(e){}},loadAllProjects:async()=>{t().isInitialized||e({isLoading:!0});try{let t=await i.P.loadAllProjects();e({savedProjects:t})}catch(e){}finally{e({isLoading:!1,isInitialized:!0})}},deleteProject:async a=>{try{await Promise.all([i.P.deleteProjectMedia(a),i.P.deleteProjectTimeline(a),i.P.deleteProject(a)]),await t().loadAllProjects();let{activeProject:r}=t();if((null==r?void 0:r.id)===a){e({activeProject:null});let t=o.B.getState(),a=d.A.getState();t.clearAllMedia(),a.clearTimeline()}}catch(e){}},closeProject:()=>{e({activeProject:null});let t=o.B.getState(),a=d.A.getState();t.clearAllMedia(),a.clearTimeline()},renameProject:async(a,r)=>{let{savedProjects:o}=t(),d=o.find(e=>e.id===a);if(!d)return void n.oR.error("Project not found",{description:"Please try again"});let l={...d,name:r,updatedAt:new Date};try{await i.P.saveProject(l),await t().loadAllProjects();let{activeProject:r}=t();(null==r?void 0:r.id)===a&&e({activeProject:l})}catch(e){n.oR.error("Failed to rename project",{description:e instanceof Error?e.message:"Please try again"})}},duplicateProject:async e=>{try{let a=await i.P.loadProject(e);if(!a)throw n.oR.error("Project not found",{description:"Please try again"}),Error("Project not found");let{savedProjects:r}=t(),o=a.name.match(/^\((\d+)\)\s+(.+)$/),d=o?o[2]:a.name,s=[];r.forEach(e=>{let t=e.name.match(/^\((\d+)\)\s+(.+)$/);t&&t[2]===d&&s.push(parseInt(t[1],10))});let c=s.length>0?Math.max(...s)+1:1,m={...a,id:(0,l.lk)(),name:"(".concat(c,") ").concat(d),createdAt:new Date,updatedAt:new Date};return await i.P.saveProject(m),await t().loadAllProjects(),m.id}catch(e){throw n.oR.error("Failed to duplicate project",{description:e instanceof Error?e.message:"Please try again"}),e}},updateProjectBackground:async a=>{let{activeProject:r}=t();if(!r)return;let o={...r,backgroundColor:a,updatedAt:new Date};try{await i.P.saveProject(o),e({activeProject:o}),await t().loadAllProjects()}catch(e){n.oR.error("Failed to update background",{description:"Please try again"})}},updateBackgroundType:async(a,r)=>{let{activeProject:o}=t();if(!o)return;let d={...o,backgroundType:a,...(null==r?void 0:r.backgroundColor)&&{backgroundColor:r.backgroundColor},...(null==r?void 0:r.blurIntensity)&&{blurIntensity:r.blurIntensity},updatedAt:new Date};try{await i.P.saveProject(d),e({activeProject:d}),await t().loadAllProjects()}catch(e){n.oR.error("Failed to update background",{description:"Please try again"})}},updateProjectFps:async a=>{let{activeProject:r}=t();if(!r)return;let o={...r,fps:a,updatedAt:new Date};try{await i.P.saveProject(o),e({activeProject:o}),await t().loadAllProjects()}catch(e){n.oR.error("Failed to update project FPS",{description:"Please try again"})}},updateCanvasSize:async(a,r)=>{let{activeProject:o}=t();if(!o)return;let d={...o,canvasSize:a,canvasMode:r,updatedAt:new Date};try{await i.P.saveProject(d),e({activeProject:d}),await t().loadAllProjects()}catch(e){n.oR.error("Failed to update canvas size",{description:"Please try again"})}},getFilteredAndSortedProjects:(e,a)=>{let{savedProjects:r}=t();return[...r.filter(t=>t.name.toLowerCase().includes(e.toLowerCase()))].sort((e,t)=>{let[r,i]=a.split("-");if("createdAt"!==r&&"name"!==r)return 0;let n=e[r],o=t[r];return void 0===n||void 0===o?0:"asc"===i?n<o?-1:+(n>o):n>o?-1:+(n<o)})},isInvalidProjectId:e=>(t().invalidProjectIds||new Set).has(e),markProjectIdAsInvalid:t=>{e(e=>({invalidProjectIds:new Set([...e.invalidProjectIds||new Set,t])}))},clearInvalidProjectIds:()=>{e({invalidProjectIds:new Set})}}))},87100:(e,t,a)=>{a.d(t,{A0:()=>i,Ij:()=>l,Tm:()=>c,gY:()=>m,of:()=>s,sn:()=>d,t_:()=>o});let r={media:{solid:"bg-blue-500",background:"",border:""},text:{solid:"bg-[#5DBAA0]",background:"bg-[#5DBAA0]",border:""},audio:{solid:"bg-green-500",background:"bg-[#915DBE]",border:""}};function i(e){let t=r[e];return"".concat(t.background," ").concat(t.border)}let n={media:60,text:25,audio:50};function o(e){return n[e]}function d(e,t){return e.slice(0,t).reduce((e,t)=>e+n[t.type]+4,0)}function l(e){return e.reduce((e,t)=>e+n[t.type],0)+4*Math.max(0,e.length-1)}let s={ELEMENT_MIN_WIDTH:80,PIXELS_PER_SECOND:50,TRACK_HEIGHT:60,DEFAULT_TEXT_DURATION:5,DEFAULT_IMAGE_DURATION:5,ZOOM_LEVELS:[.25,.5,1,1.5,2,3,4]},c=[{value:"24",label:"24 fps"},{value:"25",label:"25 fps"},{value:"30",label:"30 fps"},{value:"60",label:"60 fps"},{value:"120",label:"120 fps"}];function m(e,t){return t<=0?e:Math.round(e*t)/t}},91685:(e,t,a)=>{a.d(t,{A:()=>p});var r=a(59467),i=a(14700),n=a(80196);let o=[{name:"16:9",width:1920,height:1080},{name:"9:16",width:1080,height:1920},{name:"1:1",width:1080,height:1080},{name:"4:3",width:1440,height:1080}];var d=a(19439),l=a(82337),s=a(93146),c=a(87100);let m=e=>{let t=[...e].sort((e,t)=>e.startTime-t.startTime);for(let e=0;e<t.length-1;e++){let a=t[e],r=t[e+1];if(a.startTime+(a.duration-a.trimStart-a.trimEnd)>r.startTime)return!0}return!1},u=e=>{let t=[...e].sort((e,t)=>e.startTime-t.startTime),a=[];for(let e=0;e<t.length;e++){let r={...t[e]};if(a.length>0){let e=a[a.length-1],t=e.startTime+(e.duration-e.trimStart-e.trimEnd);r.startTime<t&&(r.startTime=t)}a.push(r)}return a},h=(e,t)=>{let a=e.replace(/ \(left\)$/,"").replace(/ \(right\)$/,"").replace(/ \(audio\)$/,"").replace(/ \(split \d+\)$/,"");return"".concat(a," (").concat(t,")")},p=(0,r.v)((e,t)=>{let r=t=>{let a=(0,i.zb)(t),r=(0,i.Oy)(a);e({_tracks:a,tracks:r})},p=async()=>{let e=l.I.getState().activeProject;if(e)try{await d.P.saveTimeline(e.id,t()._tracks)}catch(e){}},f=e=>{r(e),setTimeout(p,100)},g=(0,i.zb)([]),y=(0,i.Oy)(g);return{_tracks:g,tracks:y,history:[],redoStack:[],selectedElements:[],rippleEditingEnabled:!1,snappingEnabled:!0,getSortedTracks:()=>{let{_tracks:e}=t(),a=(0,i.zb)(e);return(0,i.Oy)(a)},pushHistory:()=>{let{_tracks:a,history:r}=t();e({history:[...r,JSON.parse(JSON.stringify(a))],redoStack:[]})},undo:()=>{let{history:a,redoStack:r,_tracks:i}=t();0!==a.length&&(f(a[a.length-1]),e({history:a.slice(0,-1),redoStack:[...r,JSON.parse(JSON.stringify(i))]}))},selectElement:function(t,a){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];e(e=>{let i=e.selectedElements.some(e=>e.trackId===t&&e.elementId===a);return r?i?{selectedElements:e.selectedElements.filter(e=>e.trackId!==t||e.elementId!==a)}:{selectedElements:[...e.selectedElements,{trackId:t,elementId:a}]}:{selectedElements:[{trackId:t,elementId:a}]}})},deselectElement:(t,a)=>{e(e=>({selectedElements:e.selectedElements.filter(e=>e.trackId!==t||e.elementId!==a)}))},clearSelectedElements:()=>{e({selectedElements:[]})},setSelectedElements:t=>e({selectedElements:t}),addTrack:e=>{t().pushHistory();let a={id:(0,s.lk)(),name:"media"===e?"Media Track":"text"===e?"Text Track":"audio"===e?"Audio Track":"Track",type:e,elements:[],muted:!1};return f([...t()._tracks,a]),a.id},insertTrackAt:(e,a)=>{t().pushHistory();let r={id:(0,s.lk)(),name:"media"===e?"Media Track":"text"===e?"Text Track":"audio"===e?"Audio Track":"Track",type:e,elements:[],muted:!1},i=[...t()._tracks];return i.splice(a,0,r),f(i),r.id},removeTrack:e=>{let{rippleEditingEnabled:a}=t();a?t().removeTrackWithRipple(e):(t().pushHistory(),f(t()._tracks.filter(t=>t.id!==e)))},removeTrackWithRipple:e=>{let{_tracks:a}=t(),r=a.find(t=>t.id===e);if(!r)return;if(t().pushHistory(),0===r.elements.length)return void f(a.filter(t=>t.id!==e));let i=r.elements.map(e=>({startTime:e.startTime,endTime:e.startTime+(e.duration-e.trimStart-e.trimEnd)}));i.sort((e,t)=>e.startTime-t.startTime);let n=[];for(let e of i)if(0===n.length)n.push({startTime:e.startTime,endTime:e.endTime,duration:e.endTime-e.startTime});else{let t=n[n.length-1];e.startTime<=t.endTime?(t.endTime=Math.max(t.endTime,e.endTime),t.duration=t.endTime-t.startTime):n.push({startTime:e.startTime,endTime:e.endTime,duration:e.endTime-e.startTime})}f(a.filter(t=>t.id!==e).map(e=>{let t=e.elements.map(e=>{let t=e.startTime;for(let e=n.length-1;e>=0;e--){let a=n[e];t>=a.endTime&&(t-=a.duration)}return{...e,startTime:Math.max(0,t)}});if(m(t)){let a=u(t);return{...e,elements:a}}return{...e,elements:t}}))},addElementToTrack:(e,a)=>{t().pushHistory();let r=t()._tracks.find(t=>t.id===e);if(!r||!(0,i.aI)(a,r).isValid||"media"===a.type&&!a.mediaId||"text"===a.type&&!a.content)return;let d=t()._tracks.reduce((e,t)=>e+t.elements.length,0),c={...a,id:(0,s.lk)(),startTime:a.startTime||0,trimStart:0,trimEnd:0};if(0===d&&"media"===c.type){let e=n.B.getState().mediaItems.find(e=>e.id===c.mediaId);if(e&&("image"===e.type||"video"===e.type)&&l.I.getState().updateCanvasSize(function(e){let t=o[0],a=Math.abs(e-t.width/t.height);for(let r of o){let i=Math.abs(e-r.width/r.height);i<a&&(a=i,t=r)}return Math.abs(e-t.width/t.height)>.1?e>1?{width:1920,height:Math.round(1920/e)}:{width:Math.round(1080*e),height:1080}:{width:t.width,height:t.height}}((0,n.C)(e)),"original"),e&&"video"===e.type&&e.fps){let t=l.I.getState();t.activeProject&&t.updateProjectFps(e.fps)}}f(t()._tracks.map(t=>t.id===e?{...t,elements:[...t.elements,c]}:t)),t().selectElement(e,c.id)},removeElementFromTrack:function(e,a){let r=!(arguments.length>2)||void 0===arguments[2]||arguments[2],{rippleEditingEnabled:i}=t();i?t().removeElementFromTrackWithRipple(e,a,r):(r&&t().pushHistory(),f(t()._tracks.map(t=>t.id===e?{...t,elements:t.elements.filter(e=>e.id!==a)}:t).filter(e=>e.elements.length>0)))},removeElementFromTrackWithRipple:function(e,a){let r=!(arguments.length>2)||void 0===arguments[2]||arguments[2],{_tracks:i,rippleEditingEnabled:n}=t();if(!n)return void t().removeElementFromTrack(e,a,r);let o=i.find(t=>t.id===e),d=null==o?void 0:o.elements.find(e=>e.id===a);if(!d||!o)return;r&&t().pushHistory();let l=d.startTime,s=d.duration-d.trimStart-d.trimEnd,c=l+s;f(i.map(t=>{let r=t.id===e,i=t.elements.filter(r=>r.id!==a||t.id!==e).map(e=>r&&e.startTime>=c?{...e,startTime:Math.max(0,e.startTime-s)}:e);if(m(i)){let e=u(i);return{...t,elements:e}}return{...t,elements:i}}).filter(e=>e.elements.length>0||e.isMain))},moveElementToTrack:(e,a,r)=>{t().pushHistory();let n=t()._tracks.find(t=>t.id===e),o=t()._tracks.find(e=>e.id===a),d=null==n?void 0:n.elements.find(e=>e.id===r);d&&o&&(0,i.aI)(d,o).isValid&&f(t()._tracks.map(t=>t.id===e?{...t,elements:t.elements.filter(e=>e.id!==r)}:t.id===a?{...t,elements:[...t.elements,d]}:t).filter(e=>e.elements.length>0))},updateElementTrim:function(e,a,r,i){let n=!(arguments.length>4)||void 0===arguments[4]||arguments[4];n&&t().pushHistory(),f(t()._tracks.map(t=>t.id===e?{...t,elements:t.elements.map(e=>e.id===a?{...e,trimStart:r,trimEnd:i}:e)}:t))},updateElementDuration:function(e,a,r){let i=!(arguments.length>3)||void 0===arguments[3]||arguments[3];i&&t().pushHistory(),f(t()._tracks.map(t=>t.id===e?{...t,elements:t.elements.map(e=>e.id===a?{...e,duration:r}:e)}:t))},updateElementStartTime:function(e,a,r){let i=!(arguments.length>3)||void 0===arguments[3]||arguments[3];i&&t().pushHistory();let n=Math.max(0,r);f(t()._tracks.map(t=>t.id===e?{...t,elements:t.elements.map(e=>e.id===a?{...e,startTime:n}:e)}:t))},updateElementStartTimeWithRipple:(e,a,r)=>{let{_tracks:i,rippleEditingEnabled:n}=t();if(!n)return void t().updateElementStartTime(e,a,r);let o=i.find(t=>t.id===e),d=null==o?void 0:o.elements.find(e=>e.id===a);if(!d||!o)return;t().pushHistory();let l=d.startTime,s=d.startTime+(d.duration-d.trimStart-d.trimEnd),c=r+(d.duration-d.trimStart-d.trimEnd),h=r-l;f(i.map(t=>{let i=t.id===e,n=t.elements.map(n=>{if(n.id===a&&t.id===e)return{...n,startTime:Math.max(0,r)};if(!i)return n;let o=n.startTime;if(n.startTime,n.duration,n.trimStart,n.trimEnd,h>0){if(o>=s)return{...n,startTime:o+h}}else if(h<0&&o>=c&&o>=l)return{...n,startTime:Math.max(0,o+h)};return n});if(m(n)){let e=u(n);return{...t,elements:e}}return{...t,elements:n}}))},toggleTrackMute:e=>{t().pushHistory(),f(t()._tracks.map(t=>t.id===e?{...t,muted:!t.muted}:t))},toggleElementHidden:(e,a)=>{t().pushHistory(),f(t()._tracks.map(t=>t.id===e?{...t,elements:t.elements.map(e=>e.id===a?{...e,hidden:!e.hidden}:e)}:t))},updateTextElement:(e,a,r)=>{t().pushHistory(),f(t()._tracks.map(t=>t.id===e?{...t,elements:t.elements.map(e=>e.id===a&&"text"===e.type?{...e,...r}:e)}:t))},splitElement:(e,a,r)=>{let{_tracks:i}=t(),n=i.find(t=>t.id===e),o=null==n?void 0:n.elements.find(e=>e.id===a);if(!o)return null;let d=o.startTime,l=o.startTime+(o.duration-o.trimStart-o.trimEnd);if(r<=d||r>=l)return null;t().pushHistory();let c=r-o.startTime,m=o.duration-o.trimStart-o.trimEnd-c,u=(0,s.lk)();return f(t()._tracks.map(t=>t.id===e?{...t,elements:t.elements.flatMap(e=>e.id===a?[{...e,trimEnd:e.trimEnd+m,name:h(e.name,"left")},{...e,id:u,startTime:r,trimStart:e.trimStart+c,name:h(e.name,"right")}]:[e])}:t)),u},splitAndKeepLeft:(e,a,r)=>{let{_tracks:i}=t(),n=i.find(t=>t.id===e),o=null==n?void 0:n.elements.find(e=>e.id===a);if(!o)return;let d=o.startTime,l=o.startTime+(o.duration-o.trimStart-o.trimEnd);if(r<=d||r>=l)return;t().pushHistory();let s=r-o.startTime,c=o.duration-o.trimStart-o.trimEnd-s;f(t()._tracks.map(t=>t.id===e?{...t,elements:t.elements.map(e=>e.id===a?{...e,trimEnd:e.trimEnd+c,name:h(e.name,"left")}:e)}:t))},splitAndKeepRight:(e,a,r)=>{let{_tracks:i}=t(),n=i.find(t=>t.id===e),o=null==n?void 0:n.elements.find(e=>e.id===a);if(!o)return;let d=o.startTime,l=o.startTime+(o.duration-o.trimStart-o.trimEnd);if(r<=d||r>=l)return;t().pushHistory();let s=r-o.startTime;f(t()._tracks.map(t=>t.id===e?{...t,elements:t.elements.map(e=>e.id===a?{...e,startTime:r,trimStart:e.trimStart+s,name:h(e.name,"right")}:e)}:t))},separateAudio:(e,a)=>{let{_tracks:r}=t(),i=r.find(t=>t.id===e),n=null==i?void 0:i.elements.find(e=>e.id===a);if(!n||(null==i?void 0:i.type)!=="media")return null;t().pushHistory();let o=r.find(e=>"audio"===e.type),d=(0,s.lk)();if(o)f(t()._tracks.map(e=>e.id===o.id?{...e,elements:[...e.elements,{...n,id:d,name:h(n.name,"audio")}]}:e));else{let e={id:(0,s.lk)(),name:"Audio Track",type:"audio",elements:[{...n,id:d,name:h(n.name,"audio")}],muted:!1};f([...t()._tracks,e])}return d},replaceElementMedia:async(e,r,i)=>{let{_tracks:o}=t(),d=o.find(t=>t.id===e),s=null==d?void 0:d.elements.find(e=>e.id===r);if(!s)return{success:!1,error:"Timeline element not found"};if("media"!==s.type)return{success:!1,error:"Replace is only available for media clips"};try{let d=n.B.getState(),s=l.I.getState();if(!s.activeProject)return{success:!1,error:"No active project found"};let{getFileType:c,getImageDimensions:m,generateVideoThumbnail:u,getMediaDuration:h}=await Promise.resolve().then(a.bind(a,80196)),p=c(i);if(!p)return{success:!1,error:"Unsupported file type. Please select a video, audio, or image file."};let g={name:i.name,type:p,file:i,url:URL.createObjectURL(i)};try{if("image"===p){let{width:e,height:t}=await m(i);g.width=e,g.height=t}else if("video"===p){let[e,{thumbnailUrl:t,width:a,height:r}]=await Promise.all([h(i),u(i)]);g.duration=e,g.thumbnailUrl=t,g.width=a,g.height=r}else"audio"===p&&(g.duration=await h(i))}catch(e){return{success:!1,error:"Failed to process ".concat(p," file: ").concat(e instanceof Error?e.message:"Unknown error")}}try{await d.addMediaItem(s.activeProject.id,g)}catch(e){return{success:!1,error:"Failed to add media to project: ".concat(e instanceof Error?e.message:"Unknown error")}}let y=d.mediaItems.find(e=>e.file===i);if(!y)return{success:!1,error:"Failed to create media item in project. Please try again."};return t().pushHistory(),f(o.map(t=>t.id===e?{...t,elements:t.elements.map(e=>e.id===r?{...e,mediaId:y.id,name:y.name,duration:y.duration||e.duration}:e)}:t)),{success:!0}}catch(e){return{success:!1,error:"Unexpected error: ".concat(e instanceof Error?e.message:"Unknown error")}}},getTotalDuration:()=>{let{_tracks:e}=t();return 0===e.length?0:Math.max(...e.map(e=>e.elements.reduce((e,t)=>Math.max(e,t.startTime+t.duration-t.trimStart-t.trimEnd),0)),0)},getProjectThumbnail:async e=>{try{let t=await d.P.loadTimeline(e),r=await d.P.loadAllMediaItems(e);if(!t||!r.length)return null;let i=t.flatMap(e=>e.elements).filter(e=>"media"===e.type).sort((e,t)=>e.startTime-t.startTime)[0];if(!i)return null;let n=r.find(e=>e.id===i.mediaId);if(!n)return null;if("video"===n.type&&n.file){let{generateVideoThumbnail:e}=await Promise.resolve().then(a.bind(a,80196)),{thumbnailUrl:t}=await e(n.file);return t}if("image"===n.type&&n.url)return n.url;return null}catch(e){return null}},redo:()=>{let{redoStack:a}=t();0!==a.length&&(f(a[a.length-1]),e({redoStack:a.slice(0,-1)}))},dragState:{isDragging:!1,elementId:null,trackId:null,startMouseX:0,startElementTime:0,clickOffsetTime:0,currentTime:0},setDragState:t=>e(e=>({dragState:{...e.dragState,...t}})),startDrag:(t,a,r,i,n)=>{e({dragState:{isDragging:!0,elementId:t,trackId:a,startMouseX:r,startElementTime:i,clickOffsetTime:n,currentTime:i}})},updateDragTime:t=>{e(e=>({dragState:{...e.dragState,currentTime:t}}))},endDrag:()=>{e({dragState:{isDragging:!1,elementId:null,trackId:null,startMouseX:0,startElementTime:0,clickOffsetTime:0,currentTime:0}})},loadProjectTimeline:async t=>{try{let a=await d.P.loadTimeline(t);if(a)r(a);else{let e=(0,i.zb)([]);r(e)}e({history:[],redoStack:[]})}catch(t){r((0,i.zb)([])),e({history:[],redoStack:[]})}},saveProjectTimeline:async e=>{try{await d.P.saveTimeline(e,t()._tracks)}catch(e){}},clearTimeline:()=>{r((0,i.zb)([])),e({history:[],redoStack:[],selectedElements:[]})},toggleSnapping:()=>{e(e=>({snappingEnabled:!e.snappingEnabled}))},toggleRippleEditing:()=>{e(e=>({rippleEditingEnabled:!e.rippleEditingEnabled}))},checkElementOverlap:(e,a,r,i)=>{let n=t()._tracks.find(t=>t.id===e);return!!n&&n.elements.some(e=>{let t=e.startTime+e.duration-e.trimStart-e.trimEnd;return e.id!==i&&(a>=e.startTime&&a<t||a+r>e.startTime&&a+r<=t||a<e.startTime&&a+r>t)})},findOrCreateTrack:e=>{if("text"===e)return t().insertTrackAt(e,0);let a=t()._tracks.find(t=>t.type===e);return a?a.id:t().addTrack(e)},addMediaAtTime:function(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r="audio"===e.type?"audio":"media",i=e.duration||c.of.DEFAULT_IMAGE_DURATION,n=t()._tracks.filter(e=>e.type===r),o=null;for(let e of n)if(!t().checkElementOverlap(e.id,a,i)){o=e.id;break}return o||(o=t().addTrack(r)),t().addElementToTrack(o,{type:"media",mediaId:e.id,name:e.name,duration:i,startTime:a,trimStart:0,trimEnd:0}),!0},addTextAtTime:function(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=t().insertTrackAt("text",0);return t().addElementToTrack(r,{type:"text",name:e.name||"Text",content:e.content||"Default Text",duration:e.duration||c.of.DEFAULT_TEXT_DURATION,startTime:a,trimStart:0,trimEnd:0,fontSize:e.fontSize||48,fontFamily:e.fontFamily||"Arial",color:e.color||"#ffffff",backgroundColor:e.backgroundColor||"transparent",textAlign:e.textAlign||"center",fontWeight:e.fontWeight||"normal",fontStyle:e.fontStyle||"normal",textDecoration:e.textDecoration||"none",x:e.x||0,y:e.y||0,rotation:e.rotation||0,opacity:void 0!==e.opacity?e.opacity:1}),!0},addMediaToNewTrack:e=>{let a="audio"===e.type?"audio":"media",r=t().findOrCreateTrack(a);return t().addElementToTrack(r,{type:"media",mediaId:e.id,name:e.name,duration:e.duration||c.of.DEFAULT_IMAGE_DURATION,startTime:0,trimStart:0,trimEnd:0}),!0},addTextToNewTrack:e=>{let a=t().insertTrackAt("text",0);return t().addElementToTrack(a,{type:"text",name:e.name||"Text",content:("content"in e?e.content:"Default Text")||"Default Text",duration:c.of.DEFAULT_TEXT_DURATION,startTime:0,trimStart:0,trimEnd:0,fontSize:("fontSize"in e?e.fontSize:48)||48,fontFamily:("fontFamily"in e?e.fontFamily:"Arial")||"Arial",color:("color"in e?e.color:"#ffffff")||"#ffffff",backgroundColor:("backgroundColor"in e?e.backgroundColor:"transparent")||"transparent",textAlign:("textAlign"in e?e.textAlign:"center")||"center",fontWeight:("fontWeight"in e?e.fontWeight:"normal")||"normal",fontStyle:("fontStyle"in e?e.fontStyle:"normal")||"normal",textDecoration:("textDecoration"in e?e.textDecoration:"none")||"none",x:("x"in e?e.x:0)||0,y:("y"in e?e.y:0)||0,rotation:("rotation"in e?e.rotation:0)||0,opacity:"opacity"in e&&void 0!==e.opacity?e.opacity:1}),!0}}})},93146:(e,t,a)=>{a.d(t,{C7:()=>c,Fe:()=>d,bT:()=>m,cn:()=>n,lg:()=>s,lk:()=>o,mr:()=>l});var r=a(54083),i=a(14234);function n(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];return(0,i.QP)((0,r.$)(t))}function o(){if("undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID)return crypto.randomUUID();let e=new Uint8Array(16);crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;let t=[...e].map(e=>e.toString(16).padStart(2,"0"));return t.slice(0,4).join("")+"-"+t.slice(4,6).join("")+"-"+t.slice(6,8).join("")+"-"+t.slice(8,10).join("")+"-"+t.slice(10,16).join("")}function d(e){return!!e&&(e instanceof Element||e instanceof HTMLElement)}function l(e){return!!e.isContentEditable||("INPUT"===e.tagName||"TEXTAREA"===e.tagName)&&!e.disabled}function s(){return/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform)}function c(){return s()?"⌘":"Ctrl"}function m(){return s()?"⌥":"Alt"}}}]);
//# sourceMappingURL=298-00f609cc23cf28b9.js.map